[tox]
envlist = process_md_images, build_docs
skipsdist = true

[testenv]
# 共用的 Python 依赖可以放这里
deps =
    requests
    -r requirements.txt

[testenv:process_md_images]
allowlist_externals =
    bash
description = 处理变更的 Markdown 图片并推送到 main
commands_pre =
    bash -c 'echo "::group::Detect changed .md files"'
    bash -c 'git fetch origin main'
    bash -c 'changed=$(git diff --name-only {env:GITHUB_EVENT_BEFORE} {env:GITHUB_SHA} | grep "\\.md$" || true); echo "Changed md files:"; echo "$changed" > changed_md_files.txt'
    bash -c 'echo "::endgroup::"'
commands =
    bash -c '[ -s changed_md_files.txt ] && python ./scripts/process_md_images.py changed_md_files.txt || echo "No markdown changes found"'
    bash -c 'git config user.name "github-actions[bot]"'
    bash -c 'git config user.email "github-actions[bot]@users.noreply.github.com"'
    bash -c 'git add . && (git diff --cached --quiet || git commit -m "Auto-update local image paths for changed md files")'
    bash -c 'git push origin main'

[testenv:build_docs]
description = 构建 Sphinx 文档并部署到 GitHub Pages
commands =
    sphinx-build -b html ./homepage ./docs_build
    bash -c 'for dir in platform/*/*; do \
        if [ -f "$dir/conf.py" ]; then \
            echo "Building $dir"; \
            outdir="docs_build/${dir#platform/}"; \
            sphinx-build -b html -c "$dir" "$dir" "$outdir"; \
        fi; \
    done'
    bash -c 'echo "docs.forlinx.net" > ./docs_build/CNAME'
    bash -c 'pip install ghp-import && ghp-import -n -p -f -b gh-pages docs_build'
